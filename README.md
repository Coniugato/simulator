# シミュレータパッケージの使い方
`simulator`、`assembler`、`displayer`、`test_binaries`、`utilities`、`developer_scripts`からなります。
## 仕様　　　　
- `simulator`  
シミュレータです。`make`すると`sim`という名前の実行ファイルが生成されます。  
現状`fround, floor`は`fcvt.w.s`で代用しています。試験が終わったら修正します。  
実行の様式は
```
./sim バイナリファイル
``` 
です。入力ファイルとして`input`が必要です。今のところバイナリ形式ではなく数字を`in`ならば整数で、`fin`ならば浮動小数でスペース区切りで書いてください。
```
例)テストバイナリinoutに対応するinput
2
4
6
1.2
45.3
12
```
入力命令を行っているのに十分な入力が`input`に与えられていない場合は`EOF detected`でエラー終了します。出力は`xxx.output`に書かれます。    
コマンドオプションとして
```
-auto 途中結果を表示せず、最終のレジスタのみを出力する。対話モードにならない。バイナリを一気にテストしたいときに使ってください。
-ifnc 入力用のファイル名を変更する。バイナリのファイル名がxxxならば、xxx.inputがファイル名となる。バイナリを一気にテストしたいときに使ってください。
```
を追加しました。これらは*必ずバイナリファイル名より後において*使ってください。シェルスクリプトにして組み合わせたりするのに便利だと思います。    
また対話モードでの使い方は以下の表を参考にしてください。  
```
Help For Debug Console:
n           次の命令を実行
s XXX       XXXクロック後の命令まで実行
e           最後の命令まで実行
r           出力抑制して最後まで実行
j XXX       出力抑制してXXXクロック後の命令まで実行
i       出力抑制して次の命令まで実行
q           シミュレータを中断
m XXX       メモリのXXX番地の内容を表示(キャッシュ含む)
m XXX-YYY   メモリのXXX番地からYYY番地まで(YYY番地を含まない)の内容を表示(キャッシュ含む)
c dXXX      データキャッシュのインデックスXXXのラインを表示
c iXXX      命令メモリのアドレスXXXの中身を表示(現状XXX-YYYのような表記はできません)
d           キャッシュ統計を表示
```
- `assembler` 
アセンブラです。`make`すると`asm`という名前の実行ファイルが生成されます。 
実行の様式は
```
./asm アセンブリファイル名 バイナリファイル名
``` 
です。この際、同時に`バイナリファイル名.0x`という名前でバイナリを`16`進表記した文字列のファイルが生成されます。  
また、`.mid_expression`、`.mid_binary`が生成されますが、これらは中間ファイルです。後者は多分何にも使えませんが、前者はアセンブリをパースしたものなので、うまくアセンブルされないときは確認するとよいかもしれません。   
- `displayer`
バイナリの内容を説明するプログラムです。`make`すると`disp`という名前の実行ファイルが生成されます。 
実行の様式は
```
./disp バイナリファイル名
``` 
です。    
- `test_binaries`  
テストバイナリチャンネルに投げたバイナリ、アセンブリ、`0x`ファイルがすべて入っています。また入力ファイル`.input`や実行結果`.executed`、`.output`もすべて入っています。      
- `utilities`  
現状`linker`スクリプトが入っています。これは複数のアセンブリをまとめて一つにするスクリプトです。  
```
./linker linked.s main.s lib1.s lib2.s ... libn.s
```
のような形で、最初に出力アセンブリファイル名を、次に最初に実行する命令を含むアセンブリを、次にライブラリ関数アセンブリ群をおけばよいです。このとき、アセンブラの形式に合うように全体が調整されます。詳しくは以下のコードを見てください。`end`フラグを使うので、もしコンパイラでこのフラグを使いたい場合は適切なフラグ名に変更してください。  
```bash
if [ "$1" = "" ]
then
    echo "No target file specified." >&2
    exit 255
fi
target=$1
shift
if [ "$1" = "" ]
then
    echo "Main source file not specified." >&2
    exit 255
fi
cat $1 > $target
echo "    j end" >> $target
shift
while [ "$1" != "" ]
do
  cat $1 >> $target
  shift
done
echo "end:nop" >> $target
```
以下三つのコマンドは、レポジトリ内ならカレントディレクトリがどこでも動くように設計してあります。  
`allclean`スクリプトを追加しました。これは実行ファイルおよび`.mid...`ファイルを消します。  
`allmake`スクリプトを追加しました。これはアセンブラ、シミュレータ、ディスプレイヤすべてをコンパイルするコマンドです。
*多分テストに便利なので以下のコマンドもぜひ使ってください*  
`alltest`スクリプトを追加しました。これは`test_binaries`ディレクトリ内のすべての拡張子`.s`のファイルに対して`.s`を除いた名前のアセンブラでバイナリを生成し、この名前を`xxx`として、シミュレータで実行し最後の結果を`xxx.executed`に保存します。また出力の結果を`xxx.output`で保存します。入力ファイルがない場合は空ファイル`xxx.input`を自動生成をするため、本質的に入力が必要な場合以外は入力ファイルを作ってあげる必要はありません(もちろん作っても動きます)。  
アセンブラやシミュレータがエラーを吐いた時には赤字で表示されます。
- `developer_scripts`
開発者用スクリプトです。基本的に使う必要はないはずです。